var twilio=twilio||{};twilio.billing=twilio.billing||{},twilio.billing.braintree={getEncryptor:function(e){var t=null;return e&&(t=Braintree.create(e)),t},getDeviceData:function(e,t){var a=null;if(e){var l="prod"==twilio.environment?"production":"sandbox",i=braintree.data.setup({paypal:t,kount:{environment:l,merchantId:e}});a=i.deviceData}return a},setupPaypal:function(e,t,a){braintree.setup(e,"paypal",{container:t,paypal:{paymentMethodNonceInputField:a,enableShippingAddress:!0,enableBillingAddress:!0,onUnsupported:function(){alert("Sorry, your browser is unsupported for Paypal")}},onPaymentMethodReceived:function(e){document.getElementById("wallet-card-address").value=e.details.billingAddress.streetAddress,document.getElementById("wallet-card-postal").value=e.details.billingAddress.postalCode,$("#wallet-card-country").selectize()[0].selectize.setValue(e.details.billingAddress.countryCodeAlpha2),document.getElementById("wallet-card-state").value=e.details.billingAddress.region,document.getElementById("wallet-card-city").value=e.details.billingAddress.locality},dataCollector:{paypal:!0}})}};var twilio=twilio||{};twilio.wallet={addCallback:null,alertContainer:"#modal-alerts",selectCallback:null,wallet:null,target:"#wallet",callbackFactory:{updateSelectedCard:function(e,t,a,l,i,n){t=t||"#credit-card-sid",a=a||".credit-card-mask",l=l||".credit-card-type",i=i||".credit-card-details",n=n||".show-wallet-link";var r=$(".js-no-payment-methods");return r.length&&(r.hide(),$(".card-buttons").removeClass("col-sm-24").addClass("col-sm-6")),function(r){if(r){$(t).val(r.sid).trigger("input"),e=e?$(e):twilio.wallet.get(),e.find(a).text(r.number||r.name),e.find(l).text(r.type),e.find(i).show();var d=e.find(n);d.length&&d.attr("href",d.attr("href").replace(/(\?.+)?$/,function(e){return e=e.replace(/[&?]?card=[^&]+/,"").replace(/^[&?]/,""),"?"+e+(e.length?"&":"")+"card="+r.sid})).text("Change").data("resetText","Change"),twilio.wallet.get().modal("pop"),$(e).trigger("updated")}}},updateBackupCard:function(e,t){return t=t||"#backup-method-sid",this.updateSelectedCard(e,t)},reloadPage:function(){return function(){window.location.reload()}}},init:function(){var e=this;this.wallet=$(this.target),0!=this.wallet.length&&(this.wallet.on("loaded",function(){e.bind(e.wallet.find(".modal-view").last())}).on("shown pushed",function(){e.analytics()}),this.wallet.find("#wallet-cards, #wallet-add-card, #wallet-edit-card").length&&this.bind(this.wallet),this.wallet.on("shown.bs.modal pushed.bs.modal",function(){var t=$(this);t.find("#wallet-cards, #wallet-add-card, #wallet-edit-card").length&&twilio.wallet.bind(t);var a=t.find("@wallet-select");if(a.length){var l=a.data("container"),i="#primary-method-container"==l?$("#backup-method-sid").val():$("#credit-card-sid").val();e.disableCCRadioBySid(i)}}),this.wallet.on("click",".js-delete-card",this.resetModalHeight.bind(this)),this.wallet.on("popped.bs.modal pushed.bs.modal",this.resetModalHeight.bind(this)))},disableCCRadioBySid:function(e){$('input[data-cc-sid="'+e+'"]').prop("checked",!1).prop("disabled",!0).addClass("disabled").parent().removeClass("checked")},resetModalHeight:function(){this.wallet.modal("refresh")},bind:function(e){var t=this;if(e.find("@wallet-add, @wallet-edit").on("click",function(e){e.preventDefault();var a=$(this).data("callback");a&&$.isFunction(t.callbackFactory[a])&&(t.addCallback=t.callbackFactory[a]()),t.add(),t.resetModalHeight()}),e.find("@wallet-select").on("click",function(e){var a=$(this);e.preventDefault();var l=a.data("callback"),i=a.data("container");l&&$.isFunction(t.callbackFactory[l])&&(t.selectCallback=t.callbackFactory[l](i)),t.select()}),e.find("#paypal-container").length){var a=decodeURI($("#ClientToken").val());twilio.billing.braintree.setupPaypal(a,"paypal-container","payment-method-nonce")}e.find("select").selectize({dropdownParent:"body"}).on("change",function(){t.isZipRequired()||t.wallet.find("#wallet-card-postal").parents(".control-group").removeClass("error")}),e.on("change","input",function(){$.trim($(this).val())&&$(this).parents(".control-group").removeClass("error")}),e.find("@tooltip").tooltip({placement:"bottom"})},bindForm:function(){var e=this;$("body").on("click","@wallet-payment-method",function(t){var a=$(t.target).attr("value");e.tabs(a)})},get:function(){return this.wallet||(this.wallet=$(this.target)),this.wallet},select:function(){var e=this.wallet.find("@wallet-card:checked"),t=e.length?$.parseJSON(e.val()):null;this.selectCallback&&this.selectCallback(t),1==this.wallet.find(".modal-view").length&&this.wallet.modal("hide")},findParent:function(e){var t=e.closest(".control-label");if(0==t.length){t=e.parent();for(var a=5;0==t.find(".control-label").length;)if(t=t.parent(),a--,a<0)return!1}return t},setError:function(e,t){twilio.alert["new"]("error",t,$(this.alertContainer)[0],{fade:!0});var a=this.findParent(e);a&&a.addClass("has-error")},clearError:function(e){var t=this.findParent(e);t&&t.removeClass("has-error")},add:function(){var e=this;twilio.alert.clear($(this.alertContainer)[0]);var t={sid:this.wallet.find("#wallet-card-sid"),name:this.wallet.find("#wallet-card-name"),number:this.wallet.find("#wallet-card-number"),expMonth:this.wallet.find("#wallet-card-expiration-month"),expYear:this.wallet.find("#wallet-card-expiration-year"),cvv:this.wallet.find("#wallet-card-cvv"),address:this.wallet.find("#wallet-card-address"),postal:this.wallet.find("#wallet-card-postal"),country:this.wallet.find("#wallet-card-country"),state:this.wallet.find("#wallet-card-state"),city:this.wallet.find("#wallet-card-city")},a={sid:!1,name:"Friendly Name",number:"Credit Card Number",expMonth:"Expiration Month",expYear:"Expiration Year",cvv:"CVV number",address:"Address",postal:"Postal Code",country:"Country"},l=$(e.target+" input[name=paymentMethod]:checked").val(),i=!0,n=0!=t.sid.length,r={};for(var d in t)if(t.hasOwnProperty(d)){var o=t[d];if(0!=o.length&&(r[d]=o.val(),"paypal"!=l))if("postal"!=d||e.isZipRequired()){var s=!$.trim(r[d]);!s||n||o.is(":hidden")?this.clearError(o):(this.setError(o,a[d]+" has an invalid value."),i=!1)}else this.clearError(o)}if(r.expMonth=+r.expMonth,r.expYear=+r.expYear,r.expYear<100&&(r.expYear=+("20"+r.expYear)),"paypal"!=l){isNaN(r.expMonth)||r.expMonth<1||r.expMonth>12?(this.setError(t.expMonth,"Expiration month is invalid"),i=!1):this.clearError(t.expMonth);var c=new Date;isNaN(r.expYear)||r.expYear<c.getFullYear()||r.expYear>c.getFullYear()+35?(this.setError(t.expYear,"Expiration year is invalid"),i=!1):this.clearError(t.expYear)}if(r.publicKey=this.wallet.find("#wallet-public-key").val(),r.publicKey){var p=twilio.billing.braintree.getEncryptor(r.publicKey);if(r.number){r.numberEnc=p.encrypt(r.number);var h=r.number.replace(/[^0-9]/g,"");if(h.length>8){for(var w="",u=0;u<h.length-8;u++)w+="*";r.numberMasked=h.substr(0,6)+w+h.substr(h.length-4,4)}}r.cvv&&(r.cvvEnc=p.encrypt(r.cvv)),r.number="",r.cvv=""}if(r.paymentMethodNonce=this.wallet.find("#payment-method-nonce").val(),r.paymentMethodNonce?i=!0:"paypal"==l&&(i=!1,twilio.alert["new"]("danger","To enable PayPal, click on the blue PayPal button below.",e.wallet.find(".modal-body").last(),{clear:!0,method:"prepend",dismissible:!1})),r.deviceData=twilio.billing.braintree.getDeviceData(this.wallet.find("#wallet-kount-merchant-id").val(),"paypal"==l),i){var f=this.wallet.find("@wallet-add, @wallet-edit");f.button("loading"),$.post("/console/wallet",r,function(t){if(t.sid)if(e.addCallback)e.addCallback(t);else{var a=e.wallet.find("#wallet-cards");if(a.length){var l="/console/wallet",i=e.wallet.find("@wallet-select"),n=i.data("callback")||"updateSelectedCard",r=i.data("container");n&&(l+="?callback="+n,r&&(l+="&container="+encodeURIComponent(r))),$.get(l,{view:!0,card:t.sid},function(t){e.bind(a.parents(".modal-view").html(t)),e.wallet.modal("pop")})}else e.wallet.modal("hide")}else twilio.alert["new"]("danger",t.error,e.wallet.find(".modal-body").last(),{clear:!0,method:"prepend",dismissible:!1}),e.wallet.modal("refresh")}).always(function(){f.button("reset")})}},tabs:function(e){var t=$(twilio.wallet.target).find("@wallet-add");t.length&&t.text("paypal"==e?"Add PayPal":"Add Credit Card"),"paypal"==e?($("@cards-tab").hide(),$("@paypal-tab").show()):($("@cards-tab").show(),$("@paypal-tab").hide()),null!==this.wallet&&this.wallet.modal("refresh")},analytics:function(){this.wallet.find("#wallet-add-card").length&&(twilio.analytics.identify(twilio.user.sid),twilio.analytics.event("credit_card_form_loaded",{page:"wallet",AccountSid:twilio.account.sid,UserSid:twilio.user.sid}))},isZipRequired:function(){var e=["US","CA","GB"],t=this.wallet.find("#wallet-card-country").val();return $.inArray(t,e)!=-1}},$(function(){$(document).on("shown.bs.modal",twilio.wallet.target,function(e){"undefined"!=typeof twilio&&"#"+$(e.target).attr("id")==twilio.wallet.target&&twilio.wallet.init()}),"undefined"!=typeof twilio&&twilio.wallet.bindForm()});
//# sourceMappingURL=wallet.js.map
